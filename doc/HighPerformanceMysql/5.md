# 复制

## 复制概述

- 复制概述

  - 复制方式

    - 基于行的复制
    - 基于语句的复制（逻辑复制）

  - 实现方法

    - 主库记录二进制日志，备库重放日志实现数据的异步复制

  - 性能

    - 启动二进制文件需要开销
    - 读操作可以读备库，以获得更好的读扩展
    - 写操作却决于写入最慢的备库部分

  - 复制解决的问题

    - 数据分布：不同地理位置分布数据备份
    - 负载均衡：将读操作分布到多个服务器上
    - 备份
    - 高可用性：缩短宕机时间

  - 复制如何工作

    ![img](img/8.jpg)  

    - 在主库上把数据更改记录到二进制日志（Binary log）中
    - 从库有一个IO线程，将主库上的日志复制到自己的中继日志(Relay log)中
    - 从库读取中继日志中的binlog日志，重新执行一遍SQL，保证数据跟主库一致
    - 因为从库同步主库的数据是串行化的，在高并发场景下，备库数据同步会有延时
    - 解决主从延迟情况下宕机，导致数据丢失问题
      - 半同步复制
        - 主库写入binlog日志，会强制立即将数据同步到从库。从库写入自己的relay log之后，返回一个ack给主库
      - 并行复制
        - 从库开启多个线程，并行读取relay log不同库的日志，然后并行重放不同库的日志


- 配置复制
  - 使用到再深入了解
- 复制拓扑
  - 一主多备
    - 适合少量写大量读的情况，可以把读压力分摊道多个备库上去，直到备库太多给主库造成负担或者带宽瓶颈为止
  - 主主复制
    - 易出现问题，两个库同时更新同一列时，解决比较困难。需要先规划好数据和权限
  - 主动-被动模式的主主复制
    - 被动服务器只提供读服务，避免同时插入问题
  - 拥有备库的主主复制
    - 每个主库添加备库，增加了可用性。但也增加维护的复杂度。
  - 主备模式-分发主库
    - 增加一个分发主库，这个分发主库主要提供主库的二进制文件，多个备库连接到分发主库上，降低主库的负担
  - 自定义复制方案
    - 根据业务规则，让每个备库拥有主库的一部分数据，备库是只读的
    - 定义不同的业务规则访问哪个备库，如果没有找到数据的时候再去通过主库来查
- 读写扩展
  - 复制无法扩展写能力，根据业务数据规则进行分区是唯一可以扩展写入的方法